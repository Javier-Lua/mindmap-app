generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

model User {
  id       String    @id @default(uuid())
  email    String    @unique
  name     String?
  canvases Canvas[]
  clusters Cluster[]
  folders  Folder[]
  graphs   Graph?
  notes    Note[]
}

model Folder {
  id       String   @id @default(uuid())
  name     String
  userId   String
  parentId String?
  canvas   Canvas?
  parent   Folder?  @relation("FolderTree", fields: [parentId], references: [id])
  children Folder[] @relation("FolderTree")
  user     User     @relation(fields: [userId], references: [id])
  notes    Note[]

  @@index([userId])
  @@index([parentId])
}

model Note {
  id          String                 @id @default(uuid())
  title       String                 @default("Untitled Thought")
  content     Json?
  rawText     String?
  embedding   Unsupported("vector")?
  x           Float                  @default(0)
  y           Float                  @default(0)
  color       String                 @default("#ffffff")
  folderId    String?
  userId      String
  type        String                 @default("text")
  fileUrl     String?
  ephemeral   Boolean                @default(true)
  sticky      Boolean                @default(false)
  priority    Int                    @default(0)
  weight      Float                  @default(1.0)
  archived    Boolean                @default(false)
  updatedAt   DateTime               @updatedAt
  createdAt   DateTime               @default(now())
  annotations Annotation[]
  canvases    Canvas[]
  outgoing    Link[]                 @relation("Source")
  incoming    Link[]                 @relation("Target")
  folder      Folder?                @relation(fields: [folderId], references: [id])
  user        User                   @relation(fields: [userId], references: [id])
  clusters    Cluster[]              @relation("NoteClusters")

  @@index([userId])
  @@index([archived])
  @@index([ephemeral, updatedAt])
  @@index([userId, archived])
  @@index([updatedAt(sort: Desc)])
}

model Link {
  id       String  @id @default(uuid())
  sourceId String
  targetId String
  strength Float   @default(1.0)
  reason   String?
  source   Note    @relation("Source", fields: [sourceId], references: [id], onDelete: Cascade)
  target   Note    @relation("Target", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetId])
  @@index([sourceId])
  @@index([targetId])
}

model Annotation {
  id      String @id @default(uuid())
  noteId  String
  text    String
  comment String
  note    Note   @relation(fields: [noteId], references: [id], onDelete: Cascade)
}

model Cluster {
  id     String @id @default(uuid())
  name   String
  userId String
  user   User   @relation(fields: [userId], references: [id])
  notes  Note[] @relation("NoteClusters")

  @@unique([name, userId])
}

model Graph {
  id        String   @id @default(uuid())
  userId    String   @unique
  metadata  Json
  edges     Json     @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Canvas {
  id        String   @id @default(uuid())
  folderId  String?  @unique
  noteId    String?  @unique
  userId    String
  nodes     Json
  edges     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  folder    Folder?  @relation(fields: [folderId], references: [id], onDelete: Cascade)
  note      Note?    @relation(fields: [noteId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([folderId])
}
