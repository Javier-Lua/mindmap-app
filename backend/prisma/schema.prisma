generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  name     String?

  notes    Note[]
  folders  Folder[]
  clusters Cluster[]

  graphs   Graph[]
  canvases Canvas[]
}

model Folder {
  id       String  @id @default(uuid())
  name     String
  userId   String
  parentId String?

  user     User    @relation(fields: [userId], references: [id])
  parent   Folder? @relation("FolderTree", fields: [parentId], references: [id])
  children Folder[] @relation("FolderTree")
  notes    Note[]
  canvas Canvas?

  @@index([userId])
  @@index([parentId])
}

model Note {
  id        String   @id @default(uuid())
  title     String   @default("Untitled Thought")
  content   Json?
  rawText   String?  @db.Text

  embedding Unsupported("vector(384)")?

  x         Float    @default(0)
  y         Float    @default(0)
  color     String   @default("#ffffff")

  folderId  String?
  userId    String

  folder    Folder? @relation(fields: [folderId], references: [id])
  user      User    @relation(fields: [userId], references: [id])

  outgoing  Link[]  @relation("Source")
  incoming  Link[]  @relation("Target")

  annotations Annotation[]
  clusters    Cluster[] @relation("NoteClusters")

  type       String   @default("text")
  fileUrl    String?

  // Messy-mind workflow fields
  ephemeral  Boolean  @default(true)
  sticky     Boolean  @default(false)
  priority   Int      @default(0)
  weight     Float    @default(1.0)
  archived   Boolean  @default(false)

  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([archived])
  @@index([ephemeral, updatedAt])
  @@index([userId, archived])
  @@index([updatedAt(sort: Desc)])
}

model Link {
  id        String @id @default(uuid())
  sourceId  String
  targetId  String

  source    Note   @relation("Source", fields: [sourceId], references: [id], onDelete: Cascade)
  target    Note   @relation("Target", fields: [targetId], references: [id], onDelete: Cascade)

  strength  Float  @default(1.0)
  reason    String?

  @@unique([sourceId, targetId])
  @@index([sourceId])
  @@index([targetId])
}

model Annotation {
  id      String @id @default(uuid())
  noteId String
  text   String
  comment String

  note   Note   @relation(fields: [noteId], references: [id], onDelete: Cascade)
}

model Cluster {
  id     String @id @default(uuid())
  name   String
  userId String

  user   User   @relation(fields: [userId], references: [id])
  notes  Note[] @relation("NoteClusters")

  @@unique([name, userId])
}

model Graph {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  nodes     Json
  edges     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([userId])
}

model Canvas {
  id        String   @id @default(uuid())
  folderId  String
  folder    Folder   @relation(fields: [folderId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  nodes     Json
  edges     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([folderId])
  @@index([userId])
  @@index([folderId])
}
